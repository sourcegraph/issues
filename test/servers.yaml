---
- name: sourcegraph-e2e
  box: google/gce
  machine_type: "custom-16-20480"
  project_id: sourcegraph-ci
  external_ip: false
  use_private_ip: true
  network: default
  username: buildkite
  ssh_key_path: "~/.ssh/id_rsa"
  shell_commands:
    - |
       cd /sourcegraph
       ./test/e2e/test.sh

- name: sourcegraph-regression
  box: google/gce
  machine_type: "custom-16-20480"
  project_id: sourcegraph-ci
  external_ip: false
  use_private_ip: true
  network: default
  username: buildkite
  ssh_key_path: "~/.ssh/id_rsa"
  shell_commands:
    - |
       cd /sourcegraph
       ./test/qa-test/test.sh

- name: sourcegraph-upgrade
  box: google/gce
  machine_type: "custom-16-20480"
  project_id: sourcegraph-ci
  external_ip: false
  use_private_ip: true
  network: default
  username: buildkite
  ssh_key_path: "~/.ssh/id_rsa"
  shell_commands:
    - |
       cd /sourcegraph
       asdf install
       yarn generate
       # Run and initialize an old Sourcegraph release
       docker run --name sourcegraph-old --detach --publish 7080:7080 --publish 127.0.0.1:3370:3370 --rm --volume ~/.sourcegraph/config:/etc/sourcegraph --volume ~/.sourcegraph/data:/var/opt/sourcegraph sourcegraph/server:$TEST_UPGRADE_FROM_SOURCEGRAPH_VERSION
       E2E_INIT=true SOURCEGRAPH_BASE_URL=http://localhost:7080 yarn run test:regression -t 'Initialize new Sourcegraph instance'
       # Upgrade to current candidate image
       docker container stop sourcegraph-old
       docker run --name sourcegraph-new --detach --publish 7080:7080 --publish 127.0.0.1:3370:3370 --rm --volume ~/.sourcegraph/config:/etc/sourcegraph --volume ~/.sourcegraph/data:/var/opt/sourcegraph sourcegraph/server:$TEST_UPGRADE_TO_SOURCEGRAPH_VERSION
       # Run regression tests
       SOURCEGRAPH_BASE_URL=http://localhost:7080 yarn run test:regression
       echo "TEST: Checking Sourcegraph instance is accessible"
       curl -f http://localhost:3370
       curl -f http://localhost:3370/healthz
       echo "ALL TESTS PASSED"
