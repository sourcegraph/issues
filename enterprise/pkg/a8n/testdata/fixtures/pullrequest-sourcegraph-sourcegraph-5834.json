{
  "ID": "MDExOlB1bGxSZXF1ZXN0MzIzNzkyNTA0",
  "Title": "a8n: Persist GitHub ChangesetEvents to database",
  "Body": "This adds the necessary methods to the `a8n.Store` to upsert, list and count `a8n.ChangesetEvents`.\r\n\r\nAfter loading changesets in the `a8n.Syncer` we upsert them into the database, making sure that on conflict they're updated.\r\n\r\nThe `key` column on `changeset_events` is added in preparation for the introduction of webhooks, where we could potentially receive the same event via API calls and via webhook payloads. In that case, we want to make sure that we can reconcile the two different representations of the same event and update the database entry to its newest version.\r\n\r\nThe PR also adds a minimal first GraphQL API for changeset events. It's minimal, because we still need to work out the schema.\r\n\r\ncc @felixfbecker \r\n",
  "State": "MERGED",
  "URL": "https://github.com/sourcegraph/sourcegraph/pull/5834",
  "Number": 5834,
  "Author": {
   "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
   "Login": "tsenart",
   "URL": "https://github.com/tsenart"
  },
  "Participants": [
   {
    "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
    "Login": "tsenart",
    "URL": "https://github.com/tsenart"
   },
   {
    "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
    "Login": "mrnugget",
    "URL": "https://github.com/mrnugget"
   }
  ],
  "TimelineItems": [
   {
    "Type": "RenamedTitleEvent",
    "Item": {
     "Actor": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "PreviousTitle": "A8n/changeset events",
     "CurrentTitle": "a8n: ChangesetEvents",
     "CreatedAt": "2019-10-02T14:49:45Z"
    }
   },
   {
    "Type": "AssignedEvent",
    "Item": {
     "Actor": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "Assignee": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "CreatedAt": "2019-10-03T12:05:41Z"
    }
   },
   {
    "Type": "IssueComment",
    "Item": {
     "DatabaseID": 537920237,
     "Author": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "Editor": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "AuthorAssociation": "CONTRIBUTOR",
     "Body": "This is a comment. EDIT",
     "URL": "https://github.com/sourcegraph/sourcegraph/pull/5834#issuecomment-537920237",
     "CreatedAt": "2019-10-03T12:18:21Z",
     "UpdatedAt": "2019-10-03T12:22:14Z",
     "IncludesCreatedEdit": true
    }
   },
   {
    "Type": "ClosedEvent",
    "Item": {
     "Actor": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "CreatedAt": "2019-10-03T14:02:51Z",
     "URL": "https://github.com/sourcegraph/sourcegraph/pull/5834#event-2684174597"
    }
   },
   {
    "Type": "ReopenedEvent",
    "Item": {
     "Actor": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "CreatedAt": "2019-10-03T14:02:54Z"
    }
   },
   {
    "Type": "PullRequestReview",
    "Item": {
     "DatabaseID": 296894453,
     "Author": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "AuthorAssociation": "CONTRIBUTOR",
     "Body": "A review",
     "State": "COMMENTED",
     "URL": "https://github.com/sourcegraph/sourcegraph/pull/5834#pullrequestreview-296894453",
     "CreatedAt": "2019-10-03T14:03:23Z",
     "UpdatedAt": "2019-10-03T14:03:23Z",
     "Commit": {
      "OID": "0830ebfae3fa8f6405d30c1d0bb6dbdfba514e3f",
      "Message": "a8n: Fix CreateChangesetEvent query",
      "URL": "https://github.com/sourcegraph/sourcegraph/commit/0830ebfae3fa8f6405d30c1d0bb6dbdfba514e3f",
      "Committer": {
       "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
       "Email": "tsenart@gmail.com",
       "Name": "Tom√°s Senart",
       "User": {
        "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
        "Login": "tsenart",
        "URL": "https://github.com/tsenart"
       }
      },
      "CommittedDate": "2019-10-02T14:41:15Z",
      "PushedDate": "2019-10-02T14:41:30Z"
     },
     "IncludesCreatedEdit": false
    }
   },
   {
    "Type": "IssueComment",
    "Item": {
     "DatabaseID": 537960109,
     "Author": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "Editor": null,
     "AuthorAssociation": "CONTRIBUTOR",
     "Body": "Making this PR the playground for fetching timeline events from Github. ",
     "URL": "https://github.com/sourcegraph/sourcegraph/pull/5834#issuecomment-537960109",
     "CreatedAt": "2019-10-03T14:04:06Z",
     "UpdatedAt": "2019-10-03T14:04:06Z",
     "IncludesCreatedEdit": false
    }
   },
   {
    "Type": "ReviewRequestedEvent",
    "Item": {
     "Actor": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "RequestedReviewer": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/1646931?v=4",
      "Login": "beyang",
      "URL": "https://github.com/beyang"
     },
     "CreatedAt": "2019-10-03T14:04:11Z"
    }
   },
   {
    "Type": "ReviewRequestedEvent",
    "Item": {
     "Actor": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "RequestedReviewer": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/3173176?v=4",
      "Login": "slimsag",
      "URL": "https://github.com/slimsag"
     },
     "CreatedAt": "2019-10-03T14:04:11Z"
    }
   },
   {
    "Type": "RenamedTitleEvent",
    "Item": {
     "Actor": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "PreviousTitle": "a8n: ChangesetEvents",
     "CurrentTitle": "[WIP] a8n: ChangesetEvents",
     "CreatedAt": "2019-10-03T14:04:27Z"
    }
   },
   {
    "Type": "UnassignedEvent",
    "Item": {
     "Actor": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "Assignee": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "CreatedAt": "2019-10-03T14:04:58Z"
    }
   },
   {
    "Type": "ReviewRequestRemovedEvent",
    "Item": {
     "Actor": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/1646931?v=4",
      "Login": "beyang",
      "URL": "https://github.com/beyang"
     },
     "RequestedReviewer": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/1646931?v=4",
      "Login": "beyang",
      "URL": "https://github.com/beyang"
     },
     "CreatedAt": "2019-10-04T19:23:05Z"
    }
   },
   {
    "Type": "ReviewRequestedEvent",
    "Item": {
     "Actor": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "RequestedReviewer": {
      "AvatarURL": "",
      "Login": "",
      "URL": ""
     },
     "CreatedAt": "2019-10-07T07:59:23Z"
    }
   },
   {
    "Type": "PullRequestReview",
    "Item": {
     "DatabaseID": 298093884,
     "Author": {
      "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
      "Login": "mrnugget",
      "URL": "https://github.com/mrnugget"
     },
     "AuthorAssociation": "CONTRIBUTOR",
     "Body": "",
     "State": "COMMENTED",
     "URL": "https://github.com/sourcegraph/sourcegraph/pull/5834#pullrequestreview-298093884",
     "CreatedAt": "2019-10-07T12:36:48Z",
     "UpdatedAt": "2019-10-07T12:36:48Z",
     "Commit": {
      "OID": "d0144535fb3207a38678ac7e436529e53768ad8f",
      "Message": "Undo previous change to GitHubSource tests",
      "URL": "https://github.com/sourcegraph/sourcegraph/commit/d0144535fb3207a38678ac7e436529e53768ad8f",
      "Committer": {
       "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
       "Email": "mrnugget@gmail.com",
       "Name": "Thorsten Ball",
       "User": {
        "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
        "Login": "mrnugget",
        "URL": "https://github.com/mrnugget"
       }
      },
      "CommittedDate": "2019-10-07T12:31:07Z",
      "PushedDate": "2019-10-07T12:31:21Z"
     },
     "IncludesCreatedEdit": false
    }
   },
   {
    "Type": "PullRequestReview",
    "Item": {
     "DatabaseID": 298094119,
     "Author": {
      "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
      "Login": "mrnugget",
      "URL": "https://github.com/mrnugget"
     },
     "AuthorAssociation": "CONTRIBUTOR",
     "Body": "",
     "State": "COMMENTED",
     "URL": "https://github.com/sourcegraph/sourcegraph/pull/5834#pullrequestreview-298094119",
     "CreatedAt": "2019-10-07T12:37:11Z",
     "UpdatedAt": "2019-10-07T12:37:12Z",
     "Commit": {
      "OID": "d0144535fb3207a38678ac7e436529e53768ad8f",
      "Message": "Undo previous change to GitHubSource tests",
      "URL": "https://github.com/sourcegraph/sourcegraph/commit/d0144535fb3207a38678ac7e436529e53768ad8f",
      "Committer": {
       "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
       "Email": "mrnugget@gmail.com",
       "Name": "Thorsten Ball",
       "User": {
        "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
        "Login": "mrnugget",
        "URL": "https://github.com/mrnugget"
       }
      },
      "CommittedDate": "2019-10-07T12:31:07Z",
      "PushedDate": "2019-10-07T12:31:21Z"
     },
     "IncludesCreatedEdit": false
    }
   },
   {
    "Type": "RenamedTitleEvent",
    "Item": {
     "Actor": {
      "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
      "Login": "mrnugget",
      "URL": "https://github.com/mrnugget"
     },
     "PreviousTitle": "[WIP] a8n: ChangesetEvents",
     "CurrentTitle": "a8n: Persist GitHub ChangesetEvents to database",
     "CreatedAt": "2019-10-07T12:42:32Z"
    }
   },
   {
    "Type": "PullRequestReview",
    "Item": {
     "DatabaseID": 298099102,
     "Author": {
      "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
      "Login": "mrnugget",
      "URL": "https://github.com/mrnugget"
     },
     "AuthorAssociation": "CONTRIBUTOR",
     "Body": "",
     "State": "APPROVED",
     "URL": "https://github.com/sourcegraph/sourcegraph/pull/5834#pullrequestreview-298099102",
     "CreatedAt": "2019-10-07T12:45:49Z",
     "UpdatedAt": "2019-10-07T12:45:49Z",
     "Commit": {
      "OID": "701963b67b97e85e10d101065015ae0cf9d0a7c9",
      "Message": "fixup! Fix indentation",
      "URL": "https://github.com/sourcegraph/sourcegraph/commit/701963b67b97e85e10d101065015ae0cf9d0a7c9",
      "Committer": {
       "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
       "Email": "mrnugget@gmail.com",
       "Name": "Thorsten Ball",
       "User": {
        "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
        "Login": "mrnugget",
        "URL": "https://github.com/mrnugget"
       }
      },
      "CommittedDate": "2019-10-07T12:39:26Z",
      "PushedDate": "2019-10-07T12:39:32Z"
     },
     "IncludesCreatedEdit": false
    }
   },
   {
    "Type": "PullRequestReview",
    "Item": {
     "DatabaseID": 298101262,
     "Author": {
      "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
      "Login": "mrnugget",
      "URL": "https://github.com/mrnugget"
     },
     "AuthorAssociation": "CONTRIBUTOR",
     "Body": "üëç \r\n\u003cimg width=\"495\" alt=\"Screen Shot 2019-10-07 at 14 49 12\" src=\"https://user-images.githubusercontent.com/1185253/66312845-a4328180-e911-11e9-93b9-d1c421324015.png\"\u003e\r\n",
     "State": "APPROVED",
     "URL": "https://github.com/sourcegraph/sourcegraph/pull/5834#pullrequestreview-298101262",
     "CreatedAt": "2019-10-07T12:49:30Z",
     "UpdatedAt": "2019-10-07T12:49:30Z",
     "Commit": {
      "OID": "701963b67b97e85e10d101065015ae0cf9d0a7c9",
      "Message": "fixup! Fix indentation",
      "URL": "https://github.com/sourcegraph/sourcegraph/commit/701963b67b97e85e10d101065015ae0cf9d0a7c9",
      "Committer": {
       "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
       "Email": "mrnugget@gmail.com",
       "Name": "Thorsten Ball",
       "User": {
        "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
        "Login": "mrnugget",
        "URL": "https://github.com/mrnugget"
       }
      },
      "CommittedDate": "2019-10-07T12:39:26Z",
      "PushedDate": "2019-10-07T12:39:32Z"
     },
     "IncludesCreatedEdit": false
    }
   },
   {
    "Type": "IssueComment",
    "Item": {
     "DatabaseID": 538999280,
     "Author": {
      "AvatarURL": "https://avatars2.githubusercontent.com/in/254?v=4",
      "Login": "codecov",
      "URL": "https://github.com/apps/codecov"
     },
     "Editor": null,
     "AuthorAssociation": "NONE",
     "Body": "# [Codecov](https://codecov.io/gh/sourcegraph/sourcegraph/pull/5834?src=pr\u0026el=h1) Report\n\u003e Merging [#5834](https://codecov.io/gh/sourcegraph/sourcegraph/pull/5834?src=pr\u0026el=desc) into [master](https://codecov.io/gh/sourcegraph/sourcegraph/commit/cec6864065fbe12890b3778af1f76c03b03c801a?src=pr\u0026el=desc) will **increase** coverage by `0.06%`.\n\u003e The diff coverage is `59.19%`.\n\n```diff\n@@            Coverage Diff             @@\n##           master    #5834      +/-   ##\n==========================================\n+ Coverage   39.37%   39.43%   +0.06%     \n==========================================\n  Files        1149     1149              \n  Lines       56184    56356     +172     \n  Branches     5650     5650              \n==========================================\n+ Hits        22121    22226     +105     \n- Misses      31998    32058      +60     \n- Partials     2065     2072       +7\n```\n\n| [Impacted Files](https://codecov.io/gh/sourcegraph/sourcegraph/pull/5834?src=pr\u0026el=tree) | Coverage Œî | |\n|---|---|---|\n| [cmd/frontend/graphqlbackend/a8n.go](https://codecov.io/gh/sourcegraph/sourcegraph/pull/5834/diff?src=pr\u0026el=tree#diff-Y21kL2Zyb250ZW5kL2dyYXBocWxiYWNrZW5kL2E4bi5nbw==) | `0% \u003c√∏\u003e (√∏)` | :arrow_up: |\n| [enterprise/pkg/a8n/syncer.go](https://codecov.io/gh/sourcegraph/sourcegraph/pull/5834/diff?src=pr\u0026el=tree#diff-ZW50ZXJwcmlzZS9wa2cvYThuL3N5bmNlci5nbw==) | `0% \u003c0%\u003e (√∏)` | :arrow_up: |\n| [cmd/frontend/graphqlbackend/graphqlbackend.go](https://codecov.io/gh/sourcegraph/sourcegraph/pull/5834/diff?src=pr\u0026el=tree#diff-Y21kL2Zyb250ZW5kL2dyYXBocWxiYWNrZW5kL2dyYXBocWxiYWNrZW5kLmdv) | `52.79% \u003c100%\u003e (+0.89%)` | :arrow_up: |\n| [enterprise/pkg/a8n/resolvers/graphql.go](https://codecov.io/gh/sourcegraph/sourcegraph/pull/5834/diff?src=pr\u0026el=tree#diff-ZW50ZXJwcmlzZS9wa2cvYThuL3Jlc29sdmVycy9ncmFwaHFsLmdv) | `62.2% \u003c33.33%\u003e (-3.7%)` | :arrow_down: |\n| [enterprise/pkg/a8n/store.go](https://codecov.io/gh/sourcegraph/sourcegraph/pull/5834/diff?src=pr\u0026el=tree#diff-ZW50ZXJwcmlzZS9wa2cvYThuL3N0b3JlLmdv) | `75.53% \u003c70.73%\u003e (-1.71%)` | :arrow_down: |\n| [pkg/extsvc/github/pulls.go](https://codecov.io/gh/sourcegraph/sourcegraph/pull/5834/diff?src=pr\u0026el=tree#diff-cGtnL2V4dHN2Yy9naXRodWIvcHVsbHMuZ28=) | `77.83% \u003c0%\u003e (+0.94%)` | :arrow_up: |\n",
     "URL": "https://github.com/sourcegraph/sourcegraph/pull/5834#issuecomment-538999280",
     "CreatedAt": "2019-10-07T13:01:51Z",
     "UpdatedAt": "2019-10-07T13:01:51Z",
     "IncludesCreatedEdit": false
    }
   },
   {
    "Type": "MergedEvent",
    "Item": {
     "Actor": {
      "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
      "Login": "mrnugget",
      "URL": "https://github.com/mrnugget"
     },
     "MergeRefName": "master",
     "URL": "https://github.com/sourcegraph/sourcegraph/pull/5834#event-2691773085",
     "Commit": {
      "OID": "705c515f173ec33bf343d5b3ea8e9cd24c10abf7",
      "Message": "a8n: Persist GitHub ChangesetEvents to database (#5834)\n\n* migrations: Create changeset_events table\r\n\r\n* a8n: Introduce CreateChangesetEvents in Store\r\n\r\n* a8n: Fix CreateChangesetEvent query\r\n\r\n* WIP: Split GitHub timeline items into ChangesetEvents\r\n\r\n* WIP\r\n\r\n* Fix tests\r\n\r\n* a8n: UpsertChangesetEvents in Store\r\n\r\n* WIP\r\n\r\n* Manually go generate code for a8n.Store to list changeset events\r\n\r\n* Recreate db/schema.md\r\n\r\n* a8n: Add CountChangesetEvents to Store\r\n\r\n* a8n: Add minimal ChangesetEvent to GraphQL API\r\n\r\n* a8n: Query ChangesetEvents in GraphQL test\r\n\r\n* Undo previous change to GitHubSource tests\r\n\r\n* a8n: Simplify test\r\n\r\n* fixup! Fix indentation\r\n\r\n* Update enterprise/pkg/a8n/store.go\r\n\r\n* Update enterprise/pkg/a8n/store.go\r\n\r\n* fixup! Fix indentation\r\n\r\n* fixup! Remove unused method",
      "URL": "https://github.com/sourcegraph/sourcegraph/commit/705c515f173ec33bf343d5b3ea8e9cd24c10abf7",
      "Committer": {
       "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
       "Email": "mrnugget@gmail.com",
       "Name": "Thorsten Ball",
       "User": {
        "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
        "Login": "mrnugget",
        "URL": "https://github.com/mrnugget"
       }
      },
      "CommittedDate": "2019-10-07T13:13:43Z",
      "PushedDate": "2019-10-07T13:13:45Z"
     },
     "CreatedAt": "2019-10-07T13:13:44Z"
    }
   },
   {
    "Type": "ClosedEvent",
    "Item": {
     "Actor": {
      "AvatarURL": "https://avatars3.githubusercontent.com/u/1185253?v=4",
      "Login": "mrnugget",
      "URL": "https://github.com/mrnugget"
     },
     "CreatedAt": "2019-10-07T13:13:44Z",
     "URL": "https://github.com/sourcegraph/sourcegraph/pull/5834#event-2691773096"
    }
   },
   {
    "Type": "AssignedEvent",
    "Item": {
     "Actor": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "Assignee": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "CreatedAt": "2019-10-08T09:45:17Z"
    }
   },
   {
    "Type": "UnassignedEvent",
    "Item": {
     "Actor": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "Assignee": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "CreatedAt": "2019-10-08T09:48:48Z"
    }
   },
   {
    "Type": "AssignedEvent",
    "Item": {
     "Actor": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "Assignee": {
      "AvatarURL": "https://avatars2.githubusercontent.com/u/67471?v=4",
      "Login": "tsenart",
      "URL": "https://github.com/tsenart"
     },
     "CreatedAt": "2019-10-08T09:50:30Z"
    }
   }
  ],
  "CreatedAt": "2019-10-02T14:49:31Z",
  "UpdatedAt": "2019-10-08T09:52:20Z"
 }